<!DOCTYPE html>
<html>

<head>
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <title>geoFlow</title>
    <link rel="stylesheet" href="css/style.css">
</head>


<body>
    <div class="wrapper" id="cosmos">
        <h1 class="title">Our Results</h1>
        <div class="intro">

        </div>
        <h2 class="subtitle">Countries where UNDP manages Global Fund grants in partnership with national governments and civil society</h2>
        <div id="world" class="world-wrapper">
            <div class="controls-container">
                <div class="selectors-container">
                    <div class="dis-selector">
                        <input type="radio" id="hiv" name="radio" />
                        <label for="hiv"><span></span>HIV</label>
                    </div>

                    <div class="dis-selector">
                        <input type="radio" id="ma" name="radio" />
                        <label for="ma"><span></span>Malaria</label>
                    </div>
                    <div class="dis-selector">
                        <input type="radio" id="tb" name="radio" />
                        <label for="tb"><span></span>Tuberculosis</label>
                    </div>
                </div>
                <hr class="divider">
                <div class="dis-result hiv-results">
                    <ul>
                        <li>2.1 million people currently on HIV treatment (2017)</li>
                        <li>41 million people received HIV counselling and testing</li>
                        <li>1 out of 6 people in Africa currently receiving HIV treatment</li>
                        <li>75% reduction in AIDS related deaths in Zimbabwe</li>
                    </ul>
                    <a class="globalfootercard globalfootercard--blue" href="#" onclick="javascript:startTour('HIV')">View HIV Country Results</a>
                </div>
                <div class="dis-result ma-results">
                    <ul>
                        <li>67 million cases of malaria treated</li>
                        <li>9 countries have achieved 100% coverage with antimalarial drugs</li>
                        <li>57 million bed nets distributed</li>
                    </ul>
                    <a class="globalfootercard globalfootercard--blue" href="#" onclick="javascript:startTour('MA')">View MALARIA Country Results</a>
                </div>
                <div class="dis-result tb-results">
                    <ul>
                        <li>850,000 cases of TB detected and put on treatment</li>
                        <li>In 12 countries the case detection rate exceeds the global target of 70%</li>
                        <li>8 countries have seen TB incidence decrease by a third</li>
                    </ul>
                    <a class="globalfootercard globalfootercard--blue" onclick="javascript:startTour('TB')" href="#">View TB Country Results</a>
                </div>
                <div class="how-to">
                    <hr class="divider">
                    <h4>How to use the globe:</h4>
                    <div>[scroll/double-click to zoom]</div>
                    <div>[click the ocean to spin the globe]</div>
                    <div>[click a highlighted country to see its results]</div>
                </div>
            </div>
            <div class="svg-wrapper">
                <div class="country-data n">
                    <h3><span class="country-name"></span> - <span class="country-status"></span></h3>

                </div>
            </div>
        </div>
        <div class="sankey-diag" style="margin-top: 100px;">
            <svg id="svgSankey" width="1024" height="1000"></svg>
        </div>
    </div>

    <script src="//d3js.org/d3.v4.min.js"></script>
    <script src="//d3js.org/d3-selection-multi.v1.min.js"></script>
    <script src="//d3js.org/queue.v1.min.js"></script>
    <script src="js/globe.js"></script>
    <script src="//unpkg.com/d3-sankey@0.7.1/build/d3-sankey.min.js"></script>
    <script src="js/countries-sankey.js"></script>
    <script>
        window.Promise || document.write('<script src="//unpkg.com/es6-promise@3.2.1/dist/es6-promise.min.js"><\/script>');

        var country_names = {};
        var id_to_names = {};
        var data_per_country = {};
        var data_per_disease = {};

        var touring = false;
        var spinning = false;
        var disease = undefined;

        var globeOptions = {
            width: 775,
            height: 600,
            disease: undefined,
            events: {
                landMouseOver: landMouseOver,
                landMouseOut: landMouseOut,
                landMouseMove: landMouseMove,
                landMouseClick: landMouseClick

            }

        };

        var globe = globe(globeOptions);

        function changeDisease(dis) {
            d3.select('#world').classed('world-wrapper', false);
            hideCountryInfo();
            globe.changeFocus(undefined);
            disease = dis;
            if (touring) {
                globe.tour(false);
            }
            if (!spinning) {
                globe.spin();
            }
            d3.select(".country-name").html("");
            d3.select(".country-status").html("");
            d3.selectAll(".indicator").html("").remove();
        }

        d3.select("#hiv").on("change", function() {
            d3.select('.subtitle').text('Countries where we work on HIV');
            d3.select("#world").classed("hiv-world", !d3.select("#world").classed("hiv-world"));
            d3.select("#world").classed("ma-world", false);
            d3.select("#world").classed("tb-world", false);
            d3.select(".hiv-results").styles({
                "display": "block"
            });
            d3.select(".ma-results").styles({
                "display": "none"
            });
            d3.select(".tb-results").styles({
                "display": "none"
            });
            changeDisease("HIV");
        });

        d3.select("#ma").on("change", function() {
            d3.select('.subtitle').text('Countries where we work on Malaria');
            d3.select("#world").classed("ma-world", !d3.select("#world").classed("ma-world"));
            d3.select("#world").classed("hiv-world", false);
            d3.select("#world").classed("tb-world", false);
            d3.select(".hiv-results").styles({
                "display": "none"
            });
            d3.select(".ma-results").styles({
                "display": "block"
            });
            d3.select(".tb-results").styles({
                "display": "none"
            });
            changeDisease("MA");
        });

        d3.select("#tb").on("change", function() {
            d3.select('.subtitle').text('Countries where we work on Tuberculosis');
            d3.select("#world").classed("tb-world", !d3.select("#world").classed("tb-world"));
            d3.select("#world").classed("ma-world", false);
            d3.select("#world").classed("hiv-world", false);
            d3.select(".hiv-results").styles({
                "display": "none"
            });
            d3.select(".ma-results").styles({
                "display": "none"
            });
            d3.select(".tb-results").styles({
                "display": "block"
            });
            changeDisease("TB");
        });


        var landTooltip = d3.select("body").append("div").attr("class", "landTooltip");
        var current_focus = undefined;

        function landMouseOver(d) {
            if (d.properties.name) {
                landTooltip.text(d.properties.name)
                    .styles({
                        "left": (d3.event.pageX + 7) + "px",
                        "top": (d3.event.pageY - 15) + "px",
                        "display": "block",
                        "opacity": 1,
                    })
            }
        }

        function landMouseMove(d) {
            landTooltip
                .styles({
                    "left": (d3.event.pageX + 7) + "px",
                    "top": (d3.event.pageY - 15) + "px",
                })
        }

        function landMouseOut(d) {
            landTooltip
                .styles({
                    "opacity": 0,
                    "display": "none",
                })
        }

        function landMouseClick(d) {

            var new_focus = globe.current_focus == d.id ? undefined : d.id;

            if (data_per_country[new_focus] && disease && data_per_disease[disease][new_focus]) {
                globe.tour(false);
                globe.spin(false);
                coordsWcurrent_focus = new_focus;
                //globe.changeFocus(current_focus)
                globe.bounce2(d.properties.name);
            }
        }



        var numberFormat = d3.format(",");

        function hideCountryInfo() {
            d3.select(".country-data").classed("shown", false);
            d3.selectAll(".label").classed("shown", true);
        }

        function showCountryInfo(country_id, disease) {
            if (country_id && disease) {
                var country = id_to_names[country_id];

                renderCountry(country, disease, data_per_disease[disease][country_id])
            }

            d3.select(".country-data").classed("shown", true);
            d3.selectAll(".label").classed("shown", false);

            function renderCountry(country, disease, data) {
                console.log(country + " - ( " + disease + " )");
                d3.select(".country-name").html("");
                d3.select(".country-name").html(country);
                var seen_indicators = [];
                if (data) {
                    var grantStatus = data[0].Status; // == "1" ? "Active" : "Inactive";
                    d3.select(".country-status").classed("cs-Active", false);
                    d3.select(".country-status").classed("cs-Inactive", false);
                    d3.select(".country-status").text(grantStatus + " grant").classed("cs-" + grantStatus, true);
                    data.forEach(function(d) {
                        if (seen_indicators[d.Indicator]) {
                            if (seen_indicators[d.Indicator].year < d.Year) {
                                seen_indicators[d.Indicator] = {
                                    "name": d.Indicator,
                                    "value": d.Value,
                                    "year": d.Year
                                };
                            }
                        } else {
                            seen_indicators[d.Indicator] = {
                                "name": d.Indicator,
                                "value": d.Value,
                                "year": d.Year
                            };
                        }

                    });
                    var lines = [];
                    var countryDataTxt = d3.select(".country-data");
                    var sel = countryDataTxt.selectAll("div").data(lines);
                    sel.exit().remove();

                    Object.keys(seen_indicators).forEach(function(ind) {
                        console.log(indicators[seen_indicators[ind].name] + ":" + seen_indicators[ind].value + " (" + seen_indicators[ind].year + ")");
                        //lines.push(indicators[seen_indicators[ind].name] + ": <b>" + numberFormat(seen_indicators[ind].value) + "</b>");
                        lines.push(seen_indicators[ind].name + ": <b>" + numberFormat(seen_indicators[ind].value) + "</b>");
                    });
                    if (data[0].Link) {
                        lines.push("<a target='_blank' class='globalfootercard globalfootercard--green--inv' href='" + data[0].Link + "'>Visit Country Results Page</a>");
                    }

                    sel = countryDataTxt.selectAll("div").data(lines);

                    sel.enter().append("div").classed("indicator", true).html(function(d) {
                        return d
                    });


                }

            }
        }

        function startTour(aDisease) {
            disease = undefined;
            globe.spin(false);
            globe.changeFocus(undefined);

            globe.tour(false).then(function() {
                disease = aDisease;
                globe.tour(true, disease).then(function() {
                    globe.rotate2().then(function() {
                        globe.changeFocus(undefined);
                    });
                });
            });
        }

        function arrayRotate(arr, reverse) {
            if (reverse)
                arr.unshift(arr.pop())
            else
                arr.push(arr.shift())
            return arr
        }

        var indicators = {
            "HAI": "Associated infections: People receiving treatment for TB/HIV",
            "HCO": "Community outreach prevention services (behavior change communications)",
            "HSTI": "Associated infections: People receiving treatment for STIs",
            "HCS": "Basic care and support services provided to orphans and vulnerable children",
            "HCD": "Condoms distributed",
            "HCTE": "Counselling and testing encounters",
            "HART": "People currently on ART",
            "HARV": "Seropositive pregnant women receiving ARV prophylaxis for PMTCT",
            "MCT": "Cases treated",
            "MND": "Nets distributed (ITNs & LLINs)",
            "MRS": "Structures covered by indoor residual spraying",
            "TPT": "MDR-TB - people treated",
            "CCCS": "People receiving care & support",
            "CCT": "'Person episodes' of training for health or community workers",
            "TBCT": "Cases successfully treated",
            "TBSP": "New smear-positive cases detected and treated"
        };
    </script>

</body>

</html>