<!DOCTYPE html>
<html>

<head>
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <title>geoFlow</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="//code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
</head>


<body>
    <div class="wrapper" id="cosmos">
        <h1 class="title">Our Results</h1>
        <div class="intro">

        </div>
        <h2 class="subtitle">Countries where UNDP manages Global Fund grants in partnership with national governments and civil society</h2>
        <div id="world" class="world-wrapper">
            <div class="controls-container">
                <div class="selectors-container">
                    <div class="dis-selector">
                        <input type="radio" id="hiv" name="radio" />
                        <label for="hiv"><span></span>HIV</label>
                    </div>

                    <div class="dis-selector">
                        <input type="radio" id="ma" name="radio" />
                        <label for="ma"><span></span>Malaria</label>
                    </div>
                    <div class="dis-selector">
                        <input type="radio" id="tb" name="radio" />
                        <label for="tb"><span></span>Tuberculosis</label>
                    </div>
                </div>
                <hr class="divider">
                <div class="dis-result hiv-results">
                    <ul>
                        <li>2.1 million people currently on HIV treatment (2017)</li>
                        <li>41 million people received HIV counselling and testing</li>
                        <li>1 out of 6 people in Africa currently receiving HIV treatment</li>
                        <li>75% reduction in AIDS related deaths in Zimbabwe</li>
                    </ul>
                    <a class="globalfootercard globalfootercard--blue" href="#" onclick="javascript:startTour('HIV')">View HIV Country Results</a>
                </div>
                <div class="dis-result ma-results">
                    <ul>
                        <li>67 million cases of malaria treated</li>
                        <li>9 countries have achieved 100% coverage with antimalarial drugs</li>
                        <li>57 million bed nets distributed</li>
                    </ul>
                    <a class="globalfootercard globalfootercard--blue" href="#" onclick="javascript:startTour('MA')">View MALARIA Country Results</a>
                </div>
                <div class="dis-result tb-results">
                    <ul>
                        <li>850,000 cases of TB detected and put on treatment</li>
                        <li>In 12 countries the case detection rate exceeds the global target of 70%</li>
                        <li>8 countries have seen TB incidence decrease by a third</li>
                    </ul>
                    <a class="globalfootercard globalfootercard--blue" onclick="javascript:startTour('TB')" href="#">View TB Country Results</a>
                </div>
                <div class="how-to">
                    <hr class="divider">
                    <h4>How to use the globe:</h4>
                    <!--div>[scroll/double-click to zoom]</div-->
                    <div>[click the ocean to spin the globe]</div>
                    <div>[click a highlighted country to see its results]</div>
                    <div>[drag to stop spinning]</div>
                    <div>[click on the legend to toggle visible countries]</div>
                </div>
            </div>
            <div class="svg-wrapper">
                <div class="legend">
                    <div class="legend-item active-grant"><span></span>Active Grant</div>
                    <div class="legend-item inactive-grant"><span></span>Inactive Grant</div>
                </div>
                <h3 class="country-name-svg n"></h3>
            </div>
        </div>
        <div class="country-data n">
        </div>
        <div class="sankey-diag" style="margin-top: 100px;">
            <svg id="svgSankey" width="1024" height="1000"></svg>
        </div>
    </div>

    <script src="//d3js.org/d3.v4.min.js"></script>
    <script src="//d3js.org/d3-selection-multi.v1.min.js"></script>
    <script src="//d3js.org/queue.v1.min.js"></script>
    <script src="/js/globe.js"></script>
    <!--script src="//unpkg.com/d3-sankey@0.7.1/build/d3-sankey.min.js"></script>
    <script src="js/countries-sankey.js"></script-->
    <script>
        window.Promise || document.write('<script src="//unpkg.com/es6-promise@3.2.1/dist/es6-promise.min.js"><\/script>');

        var regional_grants = {
            "ARGH": {
                "countries": ["BWA", "CIV", "KEN", "MWI", "NGA", "SEN", "SYC", "TZA", "UGA", "ZMB"],
                "centroid": {}
            },
            "CCRG": {
                "countries": ["BLZ", "CUB", "DOM", "GUY", "HTI", "JAM", "SUR", "TTO"],
                "centroid": {}
            },
            "MCSA": {
                "countries": ["AFG", "BGD", "BTN", "IND", "NPL", "PAK", "LKA"],
                "centroid": {}
            },
            "MCWP": {
                "countries": ["COK", "KIR", "MHL", "FSM", "NRU", "NIU", "PLW", "WSM", "TON", "TUV", "VUT"],
                "centroid": {}
            }
        }
        var country_names = {};
        var id_to_names = {};
        var data_per_country = {};
        var data_per_disease = {};

        var touring = false;
        var spinning = false;
        var disease = undefined;

        var numberFormat = d3.format(",");

        var globeOptions = {
            width: 775,
            height: 600,
            disease: undefined,
            events: {
                landMouseOver: landMouseOver,
                landMouseOut: landMouseOut,
                landMouseMove: landMouseMove,
                landMouseClick: landMouseClick

            },
            globeLoaded: GlobeLoaded

        };

        var globe = globe(globeOptions);

        function changeDisease(dis) {
            d3.select('#world').classed('world-wrapper', false);
            hideCountryInfo();
            globe.changeFocus(undefined);
            disease = dis;
            if (touring) {
                globe.tour(false);
            }
            if (!spinning) {
                globe.spin();
            }
            d3.select(".country-name").html("");
            d3.select(".country-status").html("");
            d3.selectAll(".indicator").html("").remove();
            updateLegend();
        }

        d3.select("#hiv").on("change", function() {
            d3.select('.subtitle').text('Countries where we work on HIV');
            d3.select("#world").classed("hiv-world", !d3.select("#world").classed("hiv-world"));
            d3.select("#world").classed("ma-world", false);
            d3.select("#world").classed("tb-world", false);
            d3.select(".hiv-results").styles({
                "display": "block"
            });
            d3.select(".ma-results").styles({
                "display": "none"
            });
            d3.select(".tb-results").styles({
                "display": "none"
            });
            changeDisease("HIV");
        });

        d3.select("#ma").on("change", function() {
            d3.select('.subtitle').text('Countries where we work on Malaria');
            d3.select("#world").classed("ma-world", !d3.select("#world").classed("ma-world"));
            d3.select("#world").classed("hiv-world", false);
            d3.select("#world").classed("tb-world", false);
            d3.select(".hiv-results").styles({
                "display": "none"
            });
            d3.select(".ma-results").styles({
                "display": "block"
            });
            d3.select(".tb-results").styles({
                "display": "none"
            });
            changeDisease("MA");
        });

        d3.select("#tb").on("change", function() {
            d3.select('.subtitle').text('Countries where we work on Tuberculosis');
            d3.select("#world").classed("tb-world", !d3.select("#world").classed("tb-world"));
            d3.select("#world").classed("ma-world", false);
            d3.select("#world").classed("hiv-world", false);
            d3.select(".hiv-results").styles({
                "display": "none"
            });
            d3.select(".ma-results").styles({
                "display": "none"
            });
            d3.select(".tb-results").styles({
                "display": "block"
            });
            changeDisease("TB");
        });


        var landTooltip = d3.select("body").append("div").attr("class", "landTooltip");
        var current_focus = undefined;

        function landMouseOver(d) {
            if (d.properties.name) {
                landTooltip.text(d.properties.name)
                    .styles({
                        "left": (d3.event.pageX + 7) + "px",
                        "top": (d3.event.pageY - 15) + "px",
                        "display": "block",
                        "opacity": 1,
                    })
            }
        }

        function landMouseMove(d) {
            landTooltip
                .styles({
                    "left": (d3.event.pageX + 7) + "px",
                    "top": (d3.event.pageY - 15) + "px",
                })
        }

        function landMouseOut(d) {
            landTooltip
                .styles({
                    "opacity": 0,
                    "display": "none",
                })
        }

        function landMouseClick(d) {

            var new_focus = globe.current_focus == d.id ? undefined : d.id;

            /*if (disease != undefined && !data_per_disease[disease][new_focus] || (disease != undefined && countryInGrant(new_focus) && !data_per_disease[disease][countryInGrant(new_focus)])) {
                return;
            }*/

            if (new_focus && !data_per_country[new_focus] && countryInGrant(new_focus)) {
                globe.tour(false);
                globe.spin(false);
                globe.bounce2(countryInGrant(new_focus), "grant");
            }

            if (data_per_country[new_focus] /* && disease && data_per_disease[disease][new_focus]*/ ) {
                globe.tour(false);
                globe.spin(false);
                globe.bounce2(d.properties.name);
            }
        }

        function hideCountryInfo() {
            d3.select(".country-data").classed("shown", false);
            d3.select(".country-name-svg").classed("shown", false);
            d3.selectAll(".clabel").classed("shown", true);
        }

        function showCountryInfo(country_id) {
            if (!country_id) {
                return;
            }
            $(".country-data").empty();

            d3.select(".country-name-svg").classed("shown", true);

            d3.select(".country-data").classed("shown", true);
            d3.selectAll(".clabel").classed("shown", false);

            var isGrant = country_id.length == 4;
            var country = id_to_names[country_id];
            var data = data_per_country[country_id];

            var lines = [];
            lines.push("<h3>"+ country +"</h3>");
            lines.push("<hr class='dotted'>");
            if(isGrant){
                var countriesInGrant = [];
                regional_grants[country_id].countries.forEach(function(c_id){
                    countriesInGrant.push(id_to_names[c_id]);
                });
                lines.push("<div class='grant-counties'><span style='font-weight:bold;'>Countries in grant: </span><span style='font-size:12px;text-style:italic;'>" + countriesInGrant.join(", ") + "</span></div>");
                lines.push("<hr class='dotted'>");
            }

            var link;
            lines.push("<table>")
                lines.push("<tr>")
            Object.keys(data).forEach(function(dis){
                data[dis].forEach(function(ind){
                    var act = ind.Status == "Active";
                    var status_str = act ? "<span class='cs-Active'>Active Grant</span>" :  "<span class='cs-Inactive'>Inactive Grant</span>";
                    var highlight_column = disease && ind.Disease == disease;
                    lines.push(highlight_column ? "<td class='highlight_column'>" : "<td>");
                    lines.push("<span class='dis-headline'>" + dis_to_str(ind.Disease) + " - <span>" + status_str);
                    lines.push("<hr>");
                    lines.push("<div class='indicator'><span class='ind-name'>" + ind.Indicator + ": </span><span class='ind-value'>" + ind.Value + "</span></div>");
                    lines.push("</td>")
                    if(ind.Link){
                        link = "<div style='margin:auto;width:20%;'><a target='_blank' class='globalfootercard globalfootercard--green' href='" + ind.Link + "'>Visit Country Results Page</a></div>";
                    }
                });
            })
            lines.push("</tr>")
            lines.push("</table>")

            if(link){
                lines.push(link);
            }

            $(".country-data").append(lines.join(""));

            d3.select(".country-name-svg").html(country);
        }
        function dis_to_str(dis){
            if(dis == "HIV"){
                return "HIV/AIDS";
            }
            if(dis == "TB"){
                return "Tuberculosis";
            }
            if(dis == "MA"){
                return "Malaria";
            }
        }

        function countryInGrant(country_id) {
            if (regional_grants["ARGH"].countries.indexOf(country_id) >= 0) {
                return "ARGH";
            }
            if (regional_grants["CCRG"].countries.indexOf(country_id) >= 0) {
                return "CCRG";
            }
            if (regional_grants["MCWP"].countries.indexOf(country_id) >= 0) {
                return "MCWP";
            }
            if (regional_grants["MCSA"].countries.indexOf(country_id) >= 0) {
                return "MCSA";
            }
        }

        function updateLegend() {
            $(".off-legend").removeClass("off-legend");
            $(".country-off").removeClass("country-off");

            if (disease == "HIV") {
                $(".active-grant span").css("background-color", "#E31A1C");
                $(".inactive-grant span").css("background-color", "#FB9A99");
                return;
            }
            if (disease == "MA") {
                $(".active-grant span").css("background-color", "#1F78B4");
                $(".inactive-grant span").css("background-color", "#A6CEE3");
                return;
            }
            if (disease == "TB") {
                $(".active-grant span").css("background-color", "#33A02C");
                $(".inactive-grant span").css("background-color", "#B2DF8A");
                return;
            } else {
                $(".active-grant span").css("background-color", "#FF7F00");
                $(".inactive-grant span").css("background-color", "#FDBF6F");
            }
        }

        function startTour(aDisease) {
            disease = undefined;
            globe.spin(false);
            globe.changeFocus(undefined);

            globe.tour(false).then(function() {
                disease = aDisease;
                globe.tour(true, disease).then(function() {
                    globe.rotate2().then(function() {
                        globe.changeFocus(undefined);
                    });
                });
            });
        }

        function GlobeLoaded() {
            $(".ActiveCountry.InactiveCountry").removeClass("InactiveCountry");
            updateLegend();
            $(".legend-item").click(function() {
                var act = $(this).hasClass("active-grant");
                $(this).toggleClass("off-legend");
                if (disease) {
                    act ? $("." + disease + "-active").toggleClass("country-off") : $("." + disease + "-inactive").toggleClass("country-off");
                } else {
                    act ? $(".ActiveCountry").toggleClass("country-off") : $(".InactiveCountry").toggleClass("country-off");
                }

            });
        }


        function pairedColors() {
            return colors("a6cee31f78b4b2df8a33a02cfb9a99e31a1cfdbf6fff7f00cab2d66a3d9affff99b15928");
        }

        function colors(specifier) {
            var n = specifier.length / 6 | 0,
                colors = new Array(n),
                i = 0;
            while (i < n) colors[i] = "#" + specifier.slice(i * 6, ++i * 6);
            return colors;
        }
    </script>

</body>

</html>